name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy
          pip install -r requirements.txt

      - name: Check code formatting (black)
        run: black --check src/ tests/

      - name: Check import sorting (isort)
        run: isort --check-only src/ tests/

      - name: Lint with flake8
        run: flake8 src/ tests/ --count --show-source --statistics

      - name: Validate type-ignore comments
        run: python3 scripts/validate_type_ignores.py

      - name: Type check with mypy
        run: mypy src/ --ignore-missing-imports

  config-failfast-proof:
    name: ADR-0002 Fail-Fast Proof
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run fail-fast proof tests (BLOCKING)
        run: |
          echo "=== ADR-0002 Fail-Fast Proof (BLOCKING) ==="
          pytest tests/test_config_failfast.py -v
          echo ""
          echo "✅ Fail-fast proof passed: Production mode fails fast for unsafe config"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term --junit-xml=junit-unit.xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unit
          name: codecov-umbrella
        if: always()

      - name: Upload JUnit XML (Stage 2.0)
        uses: actions/upload-artifact@v4
        with:
          name: junit-unit-tests
          path: junit-unit.xml
          retention-days: 30
        if: always()

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: quality_governance_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Alembic migrations
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:testpass@localhost:5432/quality_governance_test
        run: |
          alembic upgrade head
          echo "✅ Migrations applied successfully using Postgres context"

      - name: Validate quarantine policy
        run: |
          python3 scripts/validate_quarantine.py

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:testpass@localhost:5432/quality_governance_test
        run: |
          pytest tests/integration/ -v --cov=src --cov-report=xml --cov-report=term --junit-xml=junit-integration.xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration
          name: codecov-umbrella
        if: always()

      - name: Upload JUnit XML (Stage 2.0)
        uses: actions/upload-artifact@v4
        with:
          name: junit-integration-tests
          path: junit-integration.xml
          retention-days: 30
        if: always()

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit
          pip install -r requirements.txt

      - name: Dependency Audit with pip-audit (BLOCKING)
        run: |
          echo "=== pip-audit: Dependency Vulnerability Scan (BLOCKING) ==="
          pip-audit -r requirements.txt
          echo "✅ pip-audit passed: No vulnerabilities found"

      - name: Validate security waivers (BLOCKING)
        run: |
          echo "=== Security Waiver Validation (BLOCKING) ==="
          python3 scripts/validate_security_waivers.py
          echo ""

      - name: Security linting with Bandit (BLOCKING on High severity)
        run: |
          echo "=== Bandit: Security Linting (BLOCKING on High) ==="
          bandit -r src/ -ll -f screen
          echo ""
          echo "✅ Bandit passed: No High severity issues found"

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify application starts
        env:
          DATABASE_URL: sqlite+aiosqlite:///./test.db
          SECRET_KEY: test-secret-key
          JWT_SECRET_KEY: test-jwt-secret
        run: |
          python -c "from src.main import app; print('✅ Application imports successfully')"

  ci-security-covenant:
    name: CI Security Covenant (Stage 2.0)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate CI security covenant (BLOCKING)
        run: |
          echo "=== Stage 2.0: CI Security Covenant Validation (BLOCKING) ==="
          python3 scripts/validate_ci_security_covenant.py
          echo ""
          echo "✅ CI security covenant validation passed"

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [code-quality, config-failfast-proof, unit-tests, integration-tests, security-scan, build-check, ci-security-covenant]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate gate summary (Stage 2.0)
        run: |
          bash scripts/generate_gate_summary.sh

      - name: Upload gate summary (Stage 2.0)
        uses: actions/upload-artifact@v4
        with:
          name: gate-summary
          path: gate-summary.txt
          retention-days: 90
        if: always()

      - name: All checks passed
        run: |
          echo "✅ All CI checks passed successfully!"
          echo "The code is ready to be merged."

name: Copy Database Secret to Production

# One-time workflow to copy DATABASE_URL from staging to production
on:
  workflow_dispatch:

jobs:
  copy-secret:
    name: Copy DATABASE_URL Secret
    runs-on: ubuntu-latest
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Copy DATABASE_URL from staging to production
        run: |
          echo "Fetching DATABASE_URL from staging Key Vault..."
          DB_URL=$(az keyvault secret show --vault-name kv-qgp-staging --name DATABASE-URL --query value -o tsv)
          
          if [ -z "$DB_URL" ]; then
            echo "❌ Failed to retrieve DATABASE_URL from staging"
            exit 1
          fi
          
          echo "✅ Retrieved DATABASE_URL from staging"
          
          echo "Setting DATABASE_URL in production Key Vault..."
          az keyvault secret set --vault-name kv-qgp-prod --name DATABASE-URL --value "$DB_URL" > /dev/null
          
          echo "✅ DATABASE_URL copied to production Key Vault"
          
          echo "## Database Secret Copied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: kv-qgp-staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination**: kv-qgp-prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret**: DATABASE-URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Note**: Production is now using the same database as staging." >> $GITHUB_STEP_SUMMARY
          echo "For a true production environment, configure a separate database." >> $GITHUB_STEP_SUMMARY

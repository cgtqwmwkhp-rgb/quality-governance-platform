name: Deploy to Azure Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  IMAGE_NAME: quality-governance-platform

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
          
          echo "Building image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          
          echo "Pushing images..."
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.IMAGE_TAG }}

      - name: Run database migrations
        run: |
          echo "Running migrations via Azure Container Instance..."
          
          # Fetch secrets into variables first to avoid command substitution issues
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          DB_URL=$(az keyvault secret show --vault-name kv-qgp-staging --name DATABASE-URL --query value -o tsv)
          SECRET_KEY_VAL=$(az keyvault secret show --vault-name kv-qgp-staging --name SECRET-KEY --query value -o tsv)
          JWT_SECRET_VAL=$(az keyvault secret show --vault-name kv-qgp-staging --name JWT-SECRET-KEY --query value -o tsv)
          
          # Validate secrets were retrieved
          if [ -z "$DB_URL" ]; then
            echo "ERROR: Failed to retrieve DATABASE_URL from Key Vault"
            exit 1
          fi
          echo "Successfully retrieved secrets from Key Vault"
          
          # Create container with secure environment variables
          az container create \
            --name qgp-migration-${{ github.run_number }} \
            --resource-group rg-qgp-staging \
            --location westeurope \
            --os-type Linux \
            --image ${{ env.IMAGE_TAG }} \
            --registry-login-server ${{ env.ACR_NAME }}.azurecr.io \
            --registry-username "$ACR_USERNAME" \
            --registry-password "$ACR_PASSWORD" \
            --restart-policy Never \
            --secure-environment-variables \
              DATABASE_URL="$DB_URL" \
              SECRET_KEY="$SECRET_KEY_VAL" \
              JWT_SECRET_KEY="$JWT_SECRET_VAL" \
            --command-line "alembic upgrade head" \
            --cpu 1 \
            --memory 1
          
          echo "Waiting for migration to complete..."
          
          # Poll for completion instead of fixed sleep
          MAX_WAIT=300
          WAITED=0
          while [ $WAITED -lt $MAX_WAIT ]; do
            STATE=$(az container show --name qgp-migration-${{ github.run_number }} --resource-group rg-qgp-staging --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Running")
            if [ "$STATE" = "Terminated" ]; then
              echo "Migration container terminated after ${WAITED}s"
              break
            fi
            echo "Migration still running... (${WAITED}s)"
            sleep 10
            WAITED=$((WAITED + 10))
          done
          
          EXIT_CODE=$(az container show --name qgp-migration-${{ github.run_number }} --resource-group rg-qgp-staging --query "containers[0].instanceView.currentState.exitCode" -o tsv)
          
          echo "Migration exit code: $EXIT_CODE"
          
          echo "Migration logs:"
          az container logs --name qgp-migration-${{ github.run_number }} --resource-group rg-qgp-staging
          
          if [ "$EXIT_CODE" != "0" ]; then
            echo "Migration failed!"
            exit 1
          fi
          
          echo "Cleaning up migration container..."
          az container delete --name qgp-migration-${{ github.run_number }} --resource-group rg-qgp-staging --yes

      - name: Verify deployment
        run: |
          echo "Waiting for app to restart..."
          sleep 30
          
          echo "Testing health endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/healthz)
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Deployment successful! Health check returned 200"
          else
            echo "âŒ Deployment may have issues. Health check returned $HTTP_STATUS"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | ${{ env.IMAGE_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
